<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gembooth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script id="modes-data" type="application/json">{{ modes | tojson }}</script>
</head>
<body>
    <main class="app">
        <section class="preview">
            <video id="video" autoplay playsinline></video>
            <img id="upload-preview" alt="Preview" style="display:none; max-width:100%; max-height:100%; object-fit:contain;" />
            <canvas id="canvas" style="display:none;"></canvas>
            <div class="source-controls">
              <button id="toggle-source" class="button" title="Switch source" aria-label="Switch source">
                <span class="icon">switch_camera</span><span id="source-label">Camera</span>
              </button>
              <label class="button" for="file-input" id="upload-label" aria-label="Import photo" style="display:none;">
                <span class="icon">upload</span>Import
              </label>
              <input id="file-input" type="file" accept="image/*" style="display:none;" />
            </div>
            <button id="snap" class="shutter" aria-label="Take photo">
                <span class="icon">photo_camera</span>
            </button>
        </section>
        <section class="controls">
            <select id="mode" aria-label="Style">
                {% for key, value in modes.items() %}
                    <option value="{{ key }}">{{ value.emoji }} {{ value.name }}</option>
                {% endfor %}
                <option value="custom">✏️ Custom</option>
            </select>
            <textarea id="custom-prompt" placeholder="Describe your style" aria-label="Custom prompt" style="display:none;"></textarea>
        </section>
        <section class="gallery">
            <ul id="photo-gallery"><li id="empty-state" class="empty">Let’s make something. Take a photo or import one.</li></ul>
        </section>
        <section class="export">
            <button id="make-gif" class="button button--primary">Create GIF</button>
            <div id="gif-result"></div>
        </section>
    </main>

    <div id="lightbox" class="lightbox" aria-hidden="true" style="display:none;">
      <button id="lightbox-close" class="lightbox-close" aria-label="Close"><span class="icon">close</span></button>
      <img id="lightbox-img" alt="Full view" />
      <div class="lightbox-actions">
        <a id="lightbox-download" class="button" href="#" download>
          <span class="icon">download</span>Download
        </a>
      </div>
    </div>

    <script>
        const modesData = JSON.parse(document.getElementById('modes-data').textContent);
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const photoGallery = document.getElementById('photo-gallery');
        const modeSelector = document.getElementById('mode');
        const customPrompt = document.getElementById('custom-prompt');
        const makeGifButton = document.getElementById('make-gif');
        const gifResult = document.getElementById('gif-result');
        const toggleSourceBtn = document.getElementById('toggle-source');
        const sourceLabel = document.getElementById('source-label');
        const fileInput = document.getElementById('file-input');
        const uploadLabel = document.getElementById('upload-label');
        const uploadPreview = document.getElementById('upload-preview');

        const photos = [];
        let captureSource = 'camera'; // 'camera' | 'upload'
        let stream = null;

        async function startCamera() {
          if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) return;
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();
          } catch (e) {
            captureSource = 'upload';
            updateSourceUI();
          }
        }
        startCamera();

        function stopCamera() {
          if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
          }
          video.srcObject = null;
        }

        function updateSourceUI() {
          if (captureSource === 'camera') {
            video.style.display = '';
            uploadPreview.style.display = 'none';
            uploadLabel.style.display = 'none';
            sourceLabel.textContent = 'Camera';
            if (!stream) startCamera();
          } else {
            video.style.display = 'none';
            uploadPreview.style.display = '';
            uploadLabel.style.display = '';
            sourceLabel.textContent = 'Upload';
            stopCamera();
          }
        }

        toggleSourceBtn.addEventListener('click', () => {
          captureSource = captureSource === 'camera' ? 'upload' : 'camera';
          updateSourceUI();
        });

        fileInput.addEventListener('change', (e) => {
          const files = e && e.target && e.target.files ? e.target.files : null;
          const file = files && files.length ? files[0] : null;
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            uploadPreview.src = ev.target.result;
          };
          reader.readAsDataURL(file);
        });
        updateSourceUI();

        modeSelector.addEventListener('change', () => {
            if (modeSelector.value === 'custom') {
                customPrompt.style.display = 'block';
            } else {
                customPrompt.style.display = 'none';
            }
        });

        snap.addEventListener('click', function() {
            let dataURL;
            if (captureSource === 'camera') {
                if (!video.videoWidth || !video.videoHeight) return;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                dataURL = canvas.toDataURL('image/jpeg');
            } else {
                if (!uploadPreview.src) {
                    alert('Please choose an image to upload');
                    return;
                }
                const img = uploadPreview;
                const w = img.naturalWidth || 512;
                const h = img.naturalHeight || 512;
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                dataURL = canvas.toDataURL('image/jpeg');
            }

            const selectedMode = modeSelector.value;
            let promptText = "";
            if (selectedMode === 'custom') {
                promptText = customPrompt.value;
            } else {
                promptText = modesData[selectedMode].prompt;
            }

            const galleryItem = document.createElement('li');
            galleryItem.classList.add('isBusy');
            const originalImage = document.createElement('img');
            originalImage.src = dataURL;
            galleryItem.appendChild(originalImage);
            photoGallery.appendChild(galleryItem);
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: dataURL,
                    prompt: promptText,
                    mode: selectedMode
                })
            })
            .then(async response => {
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ error: 'Server error' }));
                    throw new Error(err.error || 'Image generation failed');
                }
                return response.json();
            })
            .then(data => {
                galleryItem.classList.remove('isBusy');
                galleryItem.innerHTML = '';

                const inputContainer = document.createElement('div');
                inputContainer.classList.add('photo');
                const inputImage = document.createElement('img');
                inputImage.src = data.input_url;
                inputImage.alt = 'Original photo';
                inputContainer.appendChild(inputImage);

                const outputContainer = document.createElement('div');
                outputContainer.classList.add('photo');
                if (data.output_url) {
                  const generatedImage = document.createElement('img');
                  generatedImage.src = data.output_url;
                  generatedImage.alt = 'Generated photo';
                  outputContainer.appendChild(generatedImage);
                  const actions = document.createElement('div');
                  actions.className = 'photo-actions';
                  const dl = document.createElement('a');
                  dl.href = data.output_url;
                  dl.download = '';
                  dl.className = 'button';
                  dl.innerHTML = '<span class="icon">download</span>';
                  actions.appendChild(dl);
                  outputContainer.appendChild(actions);
                } else {
                  const errorMsg = document.createElement('div');
                  errorMsg.style.padding = '10px';
                  errorMsg.style.whiteSpace = 'pre-wrap';
                  errorMsg.style.fontSize = '14px';
                  errorMsg.style.color = '#f66';
                  errorMsg.textContent = data.error || 'No image returned by model. Retry.';
                  outputContainer.appendChild(errorMsg);
                }

                galleryItem.appendChild(inputContainer);
                galleryItem.appendChild(outputContainer);

                const emoji = document.createElement('p');
                emoji.classList.add('emoji');
                emoji.innerText = data.emoji;
                galleryItem.appendChild(emoji);

                photos.push(data.id);

                const openLightbox = (src) => {
                  const lb = document.getElementById('lightbox');
                  const lbImg = document.getElementById('lightbox-img');
                  const lbDl = document.getElementById('lightbox-download');
                  lbImg.src = src;
                  lbDl.href = src;
                  lb.style.display = 'flex';
                  lb.classList.add('is-open');
                  lb.setAttribute('aria-hidden', 'false');
                };
                inputImage.addEventListener('click', () => openLightbox(inputImage.src));
                const genImg = outputContainer.querySelector('img');
                if (genImg) genImg.addEventListener('click', () => openLightbox(genImg.src));
            })
            .catch(err => {
                galleryItem.classList.remove('isBusy');
                galleryItem.innerHTML = '';
                const errorMsg = document.createElement('div');
                errorMsg.style.color = '#f66';
                if (err.message && err.message.includes('download')) {
                  errorMsg.textContent = 'Model download failed. Retry • Manage storage.';
                } else {
                  errorMsg.textContent = `Error: ${err.message}. Retry.`;
                }
                galleryItem.appendChild(errorMsg);
            });
        });

        makeGifButton.addEventListener('click', () => {
            fetch('/make_gif', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ photo_ids: photos })
            })
            .then(async response => {
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ error: 'Server error' }));
                    throw new Error(err.error || 'Failed to make GIF');
                }
                return response.json();
            })
            .then(data => {
                const gifImage = document.createElement('img');
                gifImage.src = data.gif_url;
                gifResult.innerHTML = '';
                gifResult.appendChild(gifImage);
            })
            .catch(err => {
                gifResult.textContent = `Error: ${err.message}. Retry.`;
            });
        });

    </script>
    <script>
      (function(){
        const lb = document.getElementById('lightbox');
        const closeBtn = document.getElementById('lightbox-close');
        function close(){
          lb.classList.remove('is-open');
          lb.setAttribute('aria-hidden', 'true');
          lb.style.display = 'none';
        }
        closeBtn.addEventListener('click', close);
        lb.addEventListener('click', (e) => {
          if (e.target === lb) close();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close();
        });
      })();
    </script>
</body>
</html>
